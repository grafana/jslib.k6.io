var R=class i{_protocol;_hostname;_port;static DEFAULT_PROTOCOL="https";constructor(e){let s=!e.startsWith("http://")&&!e.startsWith("https://")?`${i.DEFAULT_PROTOCOL}://${e}`:e,t=s.match(/^https?:/),n=s.replace(/^https?:\/\//,""),[o]=n.split("/");this._protocol=t?t[0].slice(0,-1):i.DEFAULT_PROTOCOL,this._hostname=o.split(":")[0],this._port=o.split(":")[1]?parseInt(o.split(":")[1]):void 0}copy(){return new i(this.href)}get host(){return this._port?`${this._hostname}:${this._port}`:this._hostname}set host(e){let[r,s]=e.split(":");this._hostname=r,this._port=s?parseInt(s):void 0}get hostname(){return this._hostname}set hostname(e){this._hostname=e}get href(){return`${this.protocol}://${this.host}`}set href(e){let r=e.match(/^https?:/),s=e.replace(/^https?:\/\//,""),[t]=s.split("/");this._protocol=r?r[0].slice(0,-1):i.DEFAULT_PROTOCOL,this._hostname=t.split(":")[0],this._port=t.split(":")[1]?parseInt(t.split(":")[1]):void 0}get port(){return this._port}set port(e){this._port=e}get protocol(){return this._protocol}set protocol(e){this._protocol=e}};var j=class i{region;accessKeyId;secretAccessKey;sessionToken;endpoint;static fromEnvironment(e){let r=__ENV.AWS_REGION,s=__ENV.AWS_ACCESS_KEY_ID,t=__ENV.AWS_SECRET_ACCESS_KEY,n=__ENV.AWS_SESSION_TOKEN,o=e?.endpoint;return new i({region:r,accessKeyId:s,secretAccessKey:t,sessionToken:n,endpoint:o})}constructor(e){if(!e.region||e.region==="")throw new f(`invalid AWS region; reason: expected a valid AWS region name (e.g. "us-east-1"), got \`${e.region}\``);if(!e.accessKeyId||e.accessKeyId==="")throw new f(`invalid AWS access key ID; reason: expected a non empty string, got \`${e.accessKeyId}\``);if(e.accessKeyId.length<16||e.accessKeyId.length>128&&e.sessionToken!=null)throw new f(`invalid AWS access key ID; reason: size should be between 16 and 128 characters, got ${e.accessKeyId.length}`);if(!e.secretAccessKey||e.secretAccessKey==="")throw new f(`invalid AWS secret access key; reason: expected a non empty string, got \`${e.secretAccessKey}\``);this.region=e.region,this.accessKeyId=e.accessKeyId,this.secretAccessKey=e.secretAccessKey,e.sessionToken!==void 0&&(this.sessionToken=e.sessionToken),e.endpoint!==void 0&&(typeof e.endpoint=="string"?this.endpoint=new R(e.endpoint):this.endpoint=e.endpoint)}},f=class extends Error{constructor(e){super(e)}};import{parseHTML as Ee}from"k6/html";var l=class i extends Error{code;constructor(e,r){super(e),this.name="AWSError",this.code=r}static parseXML(e){let r=Ee(e);return new i(r.find("Message").text(),r.find("Code").text())}static parse(e){if(e.headers["Content-Type"]==="application/json"){let r=e.json()||{},s=r.Message||r.message||r.__type||"An error occurred on the server side",t=e.headers["X-Amzn-Errortype"]||r.__type;return new i(s,t)}else return i.parseXML(e.body)}},m=class extends Error{code;name;constructor(e,r){super(Te[r]||"An unknown error occurred"),this.name=e,this.code=r}},_=class extends m{constructor(e){super("GeneralError",e)}},D=class extends m{constructor(e){super("DNSError",e)}},H=class extends m{constructor(e){super("TCPError",e)}},C=class extends m{constructor(e){super("TLSError",e)}},I=class extends m{constructor(e){super("HTTP2Error",e)}};var Te={1e3:"A generic error that isn\u2019t any of the ones listed below",1010:"A non-TCP network error - this is a placeholder and there is no error currently known to trigger it",1020:"An invalid URL was specified",1050:"The HTTP request has timed out",1100:"A generic DNS error that isn\u2019t any of the ones listed below",1101:"No IP for the provided host was found",1110:"Blacklisted IP was resolved or a connection to such was tried to be established",1111:"Blacklisted hostname using The Block Hostnames option",1200:"A generic TCP error that isn\u2019t any of the ones listed below",1201:"A \u201Cbroken pipe\u201D on write - the other side has likely closed the connection",1202:"An unknown TCP error - We got an error that we don\u2019t recognize but it is from the operating system and has errno set on it. The message in error includes the operation(write,read) and the errno, the OS, and the original message of the error",1210:"General TCP dial error",1211:"Dial timeout error - the timeout for the dial was reached",1212:"Dial connection refused - the connection was refused by the other party on dial",1213:"Dial unknown error",1220:"Reset by peer - the connection was reset by the other party, most likely a server",1300:"General TLS error",1310:"Unknown authority - the certificate issuer is unknown",1311:"The certificate doesn\u2019t match the hostname",1600:"A generic HTTP/2 error that isn\u2019t any of the ones listed below",1610:"A general HTTP/2 GoAway error"};import E from"k6/crypto";var J="X-Amz-Algorithm",ee="X-Amz-Credential",B="X-Amz-Date",te="X-Amz-Expires",q="X-Amz-Signature",re="X-Amz-SignedHeaders",ye="X-Amz-Target",z="X-Amz-Security-Token",k="x-amz-content-sha256",W=B.toLowerCase(),se=q.toLowerCase(),Ce=ye.toLowerCase(),ne=z.toLowerCase(),K="authorization",fe="date",oe=[K,W,fe],x="host",ie={authorization:!0,"cache-control":!0,connection:!0,expect:!0,from:!0,"keep-alive":!0,"max-forwards":!0,pragma:!0,referer:!0,te:!0,trailer:!0,"transfer-encoding":!0,upgrade:!0,"user-agent":!0,"x-amzn-trace-id":!0},Y="aws4_request",w="AWS4-HMAC-SHA256",ae=60*60*24*7,ce="e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";var de="UNSIGNED-PAYLOAD";function he(i,e){i=i.toLowerCase();for(let r of Object.keys(e))if(i===r.toLowerCase())return!0;return!1}function ue(i){return typeof ArrayBuffer=="function"&&(i instanceof ArrayBuffer||Object.prototype.toString.call(i)==="[object ArrayBuffer]")}var U=class{service;region;credentials;uriEscapePath;applyChecksum;constructor({service:e,region:r,credentials:s,uriEscapePath:t,applyChecksum:n}){this.service=e,this.region=r,this.credentials=s,this.uriEscapePath=typeof t=="boolean"?t:!0,this.applyChecksum=typeof n=="boolean"?n:!0}sign(e,r={}){let t={...{signingDate:new Date,unsignableHeaders:new Set,signableHeaders:new Set},...r},{longDate:n,shortDate:o}=pe(t.signingDate),a=t.signingService||this.service,c=t.signingRegion||this.region,d=`${o}/${c}/${a}/${Y}`;e.headers[x]||(e.headers[x]=e.endpoint.hostname);for(let b of Object.keys(e.headers))oe.indexOf(b.toLowerCase())>-1&&delete e.headers[b];e.headers[W]=n,this.credentials.sessionToken&&(e.headers[ne]=this.credentials.sessionToken),ArrayBuffer.isView(e.body)&&(e.body=e.body.buffer),e.body||(e.body="");let h=this.computePayloadHash(e);!he(k,e.headers)&&this.applyChecksum&&(e.headers[k]=h);let y=this.computeCanonicalHeaders(e,t.unsignableHeaders,t.signableHeaders),A=this.calculateSignature(n,d,this.deriveSigningKey(this.credentials,a,c,o),this.createCanonicalRequest(e,y,h));e.headers[K]=`${w} Credential=${this.credentials.accessKeyId}/${d}, SignedHeaders=${Object.keys(y).sort().join(";")}, Signature=${A}`;let g=e.endpoint.href;return e.path&&(!g.endsWith("/")&&!e.path.startsWith("/")&&(g+="/"),g+=e.path),e.query&&(g+=`?${this.serializeQueryParameters(e.query)}`),{url:g,...e}}presign(e,r={}){let{signingDate:s=new Date,expiresIn:t=3600,unsignableHeaders:n,unhoistableHeaders:o,signableHeaders:a,signingRegion:c,signingService:d}=r,{longDate:h,shortDate:y}=pe(s),A=c||this.region,g=d||this.service;if(t>ae)throw new S("Signature version 4 presigned URLs can't be valid for more than 7 days");let b=`${y}/${A}/${g}/${Y}`,u=this.moveHeadersToQuery(e,{unhoistableHeaders:o});u.headers[x]||(u.headers[x]=e.endpoint.hostname),this.credentials.sessionToken&&(u.query[z]=this.credentials.sessionToken),u.query[J]=w,u.query[ee]=`${this.credentials.accessKeyId}/${b}`,u.query[B]=h,u.query[te]=t.toString(10);let V=this.computeCanonicalHeaders(u,n,a);u.query[re]=Object.keys(V).sort().join(";");let ge=this.deriveSigningKey(this.credentials,g,A,y),le=this.computePayloadHash(e),me=this.createCanonicalRequest(u,V,le);u.query[q]=this.calculateSignature(h,b,ge,me);let P=e.endpoint.href;return u.path&&(!P.endsWith("/")&&!u.path.startsWith("/")&&(P+="/"),P+=u.path),u.query&&(P+=`?${this.serializeQueryParameters(u.query)}`),{url:P,...u}}createCanonicalRequest(e,r,s){let t=Object.keys(r).sort(),n=t.map(a=>`${a}:${r[a]}`).join(`
`),o=t.join(";");return`${e.method}
${this.computeCanonicalURI(e)}
${this.computeCanonicalQuerystring(e)}
${n}

${o}
${s}`}createStringToSign(e,r,s){let t=E.sha256(s,"hex");return`${w}
${e}
${r}
${t}`}calculateSignature(e,r,s,t){let n=this.createStringToSign(e,r,t);return E.hmac("sha256",s,n,"hex")}deriveSigningKey(e,r,s,t){let n=e.secretAccessKey,o=E.hmac("sha256","AWS4"+n,t,"binary"),a=N(o),c=E.hmac("sha256",Z(a),s,"binary"),d=N(c),h=E.hmac("sha256",Z(d),r,"binary"),y=N(h),A=E.hmac("sha256",Z(y),"aws4_request","binary");return N(A)}computeCanonicalURI({path:e}){if(this.uriEscapePath){let r=[];for(let c of e.split("/"))c?.length!==0&&c!=="."&&(c===".."?r.pop():r.push(c));let s=e?.startsWith("/")?"/":"",t=r.join("/"),n=r.length>0&&e?.endsWith("/")?"/":"",o=`${s}${t}${n}`;return encodeURIComponent(o).replace(/%2F/g,"/")}return e}computeCanonicalQuerystring({query:e={}}){let r=[],s={};for(let t of Object.keys(e).sort()){if(t.toLowerCase()===se)continue;r.push(t);let n=e[t];typeof n=="string"?s[t]=`${T(t)}=${T(n)}`:Array.isArray(n)&&(s[t]=n.slice(0).sort().reduce((o,a)=>o.concat([`${T(t)}=${T(a)}`]),[]).join("&"))}return r.map(t=>s[t]).filter(t=>t).join("&")}computeCanonicalHeaders({headers:e},r,s){let t={};for(let n of Object.keys(e).sort()){if(e[n]==null)continue;let o=n.toLowerCase();(o in ie||r?.has(o))&&(!s||s&&!s.has(o))||typeof e[n]=="string"&&(t[o]=e[n]=e[n].trim().replace(/\s+/g," "))}return t}computePayloadHash({headers:e,body:r}){return e[k]?e[k]:r==null?ce:typeof r=="string"||ue(r)?E.sha256(r,"hex").toLowerCase():ArrayBuffer.isView(r)?E.sha256(r.buffer,"hex").toLowerCase():de}moveHeadersToQuery(e,r={}){let s=JSON.parse(JSON.stringify(e)),{headers:t,query:n={}}=s;for(let o of Object.keys(t)){let a=o.toLowerCase();a.slice(0,6)==="x-amz-"&&!r.unhoistableHeaders?.has(a)&&(n[o]=t[o],delete t[o])}return{...s,headers:t,query:n}}serializeQueryParameters(e,r){let s=[],t={};for(let n of Object.keys(e).sort()){if(r?.includes(n.toLowerCase()))continue;s.push(n);let o=e[n];typeof o=="string"?t[n]=`${T(n)}=${T(o)}`:Array.isArray(o)&&(t[n]=o.slice(0).sort().reduce((a,c)=>a.concat([`${T(n)}=${T(c)}`]),[]).join("&"))}return s.map(n=>t[n]).filter(n=>n).join("&")}},S=class extends l{constructor(e,r){super(e,r),this.name="InvalidSignatureError"}};function N(i){return new Uint8Array(i)}function Z(i){return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}function T(i){let e=r=>`%${r.charCodeAt(0).toString(16).toUpperCase()}`;return encodeURIComponent(i).replace(/[!'()*]/g,e)}function pe(i){let e=Re(i).replace(/[-:]/g,"");return{longDate:e,shortDate:e.slice(0,8)}}function Re(i){return Se(i).toISOString().replace(/\.\d{3}Z$/,"Z")}function Se(i){return typeof i=="number"?new Date(i*1e3):typeof i=="string"?Number(i)?new Date(Number(i)*1e3):new Date(i):i}import{parseHTML as Q}from"k6/html";import p from"k6/http";var M=class{awsConfig;serviceName;baseRequestParams={responseType:"text"};_endpoint;constructor(e,r){this.awsConfig=e,this.serviceName=r,e.endpoint!=null&&(this._endpoint=e.endpoint)}get endpoint(){return this._endpoint==null&&(this._endpoint=new R(`https://${this.serviceName}.${this.awsConfig.region}.amazonaws.com`)),this._endpoint}set endpoint(e){this._endpoint=e}handleError(e,r){let s=e.status,t=e.error_code,n=e.error;if(s>=200&&s<300&&n==""&&t===0)return!1;switch(t){case 1e3:case 1010:case 1020:case 1050:throw new _(t);case 1100:case 1101:case 1110:case 1111:throw new D(t);case 1200:case 1201:case 1202:case 1210:case 1211:case 1212:case 1213:case 1220:throw new H(t);case 1300:case 1310:case 1311:throw new C(t);case 1600:case 1610:throw new I(t)}return!0}};var F=class extends M{signature;constructor(e){super(e,"s3"),this.signature=new U({service:this.serviceName,region:this.awsConfig.region,credentials:{accessKeyId:this.awsConfig.accessKeyId,secretAccessKey:this.awsConfig.secretAccessKey,sessionToken:this.awsConfig.sessionToken},uriEscapePath:!1,applyChecksum:!0})}async listBuckets(){let e="GET",r=this.signature.sign({method:"GET",endpoint:this.endpoint,path:"/",headers:{}},{}),s=await p.asyncRequest(e,r.url,r.body||null,{...this.baseRequestParams,headers:r.headers});this.handleError(s,"ListBuckets");let t=[];return Q(s.body).find("Buckets").children().each((o,a)=>{let c={};a.children().forEach(d=>{switch(d.nodeName()){case"name":Object.assign(c,{name:d.textContent()});break;case"creationdate":Object.assign(c,{creationDate:Date.parse(d.textContent())})}}),t.push(c)}),t}async listObjects(e,r){let s="GET",t=this.signature.sign({method:s,endpoint:this.endpoint,path:encodeURI(`/${e}/`),query:{"list-type":"2",prefix:r||""},headers:{}},{}),n=await p.asyncRequest(s,t.url,t.body||null,{...this.baseRequestParams,headers:t.headers});this.handleError(n,"ListObjectsV2");let o=[];return Q(n.body).find("Contents").each((a,c)=>{let d={};c.children().forEach(h=>{switch(h.nodeName()){case"key":Object.assign(d,{key:h.textContent()});break;case"lastmodified":Object.assign(d,{lastModified:Date.parse(h.textContent())});break;case"etag":Object.assign(d,{etag:h.textContent()});break;case"size":Object.assign(d,{size:parseInt(h.textContent())});break;case"storageclass":Object.assign(d,{storageClass:h.textContent()})}}),o.push(d)}),o}async getObject(e,r,s={}){let t="GET",n=this.signature.sign({method:t,endpoint:this.endpoint,path:encodeURI(`/${e}/${r}`),headers:{...s}},{}),o="text";"Accept"in s&&s.Accept!==void 0&&s.Accept==="application/octet-stream"&&(o="binary");let a=await p.asyncRequest(t,n.url,null,{...this.baseRequestParams,headers:n.headers,responseType:o});return this.handleError(a,"GetObject"),new $(r,Date.parse(a.headers["Last-Modified"]),a.headers.ETag,parseInt(a.headers["Content-Length"]),a.headers["X-Amz-Storage-Class"]??"STANDARD",a.body)}async putObject(e,r,s,t){let n="PUT",o=this.signature.sign({method:n,endpoint:this.endpoint,path:encodeURI(`/${e}/${r}`),headers:{Host:this.endpoint.host,...t?.contentDisposition&&{"Content-Disposition":t.contentDisposition},...t?.contentEncoding&&{"Content-Encoding":t.contentEncoding},...t?.contentLength&&{"Content-Length":t.contentLength},...t?.contentMD5&&{"Content-MD5":t.contentMD5},...t?.contentType&&{"Content-Type":t.contentType}},body:s},{}),a=await p.asyncRequest(n,o.url,o.body,{...this.baseRequestParams,headers:o.headers});return this.handleError(a,"PutObject"),L.fromResponse(a,r)}async deleteObject(e,r){let s="DELETE",t=this.signature.sign({method:s,endpoint:this.endpoint,path:encodeURI(`/${e}/${r}`),headers:{}},{}),n=await p.asyncRequest(s,t.url,t.body||null,{...this.baseRequestParams,headers:t.headers});this.handleError(n,"DeleteObject")}async copyObject(e,r,s,t){let n="PUT",o=this.endpoint.copy();o.hostname=`${s}.${this.endpoint.hostname}`;let a=this.signature.sign({method:n,endpoint:o,path:encodeURI(`/${t}`),headers:{"x-amz-copy-source":`${e}/${r}`}},{}),c=await p.asyncRequest(n,a.url,a.body||null,{...this.baseRequestParams,headers:a.headers});this.handleError(c,"CopyObject")}async createMultipartUpload(e,r){let s="POST",t=this.endpoint.copy();t.hostname=`${e}.${this.endpoint.hostname}`;let n=this.signature.sign({method:s,endpoint:t,path:encodeURI(`/${r}`),headers:{},query:{uploads:""}},{}),o=await p.asyncRequest(s,n.url,n.body||null,{...this.baseRequestParams,headers:n.headers});return this.handleError(o,"CreateMultipartUpload"),new v(r,Q(o.body).find("UploadId").text())}async uploadPart(e,r,s,t,n){let o="PUT",a=this.endpoint.copy();a.hostname=`${e}.${this.endpoint.hostname}`;let c=this.signature.sign({method:o,endpoint:a,path:encodeURI(`/${r}`),headers:{},body:n,query:{partNumber:`${t}`,uploadId:`${s}`}},{}),d=await p.asyncRequest(o,c.url,c.body||null,{...this.baseRequestParams,headers:c.headers});return this.handleError(d,"UploadPart"),new G(t,d.headers.Etag)}async completeMultipartUpload(e,r,s,t){let n="POST",o=`<CompleteMultipartUpload>${t.map(h=>`<Part><PartNumber>${h.partNumber}</PartNumber><ETag>${h.eTag}</ETag></Part>`).join("")}</CompleteMultipartUpload>`,a=this.endpoint.copy();a.hostname=`${e}.${this.endpoint.hostname}`;let c=this.signature.sign({method:n,endpoint:a,path:encodeURI(`/${r}`),headers:{},body:o,query:{uploadId:`${s}`}},{}),d=await p.asyncRequest(n,c.url,c.body||null,{...this.baseRequestParams,headers:c.headers});this.handleError(d,"CompleteMultipartUpload")}async abortMultipartUpload(e,r,s){let t="DELETE",n=this.endpoint.copy();n.hostname=`${e}.${this.endpoint.hostname}`;let o=this.signature.sign({method:t,endpoint:n,path:encodeURI(`/${r}`),headers:{},query:{uploadId:`${s}`}},{}),a=await p.asyncRequest(t,o.url,o.body||null,{...this.baseRequestParams,headers:o.headers});this.handleError(a,"AbortMultipartUpload")}handleError(e,r){if(!super.handleError(e))return!1;let t=e.error;if(e.status==301||t&&t.startsWith("301"))throw new O("Resource not found","ResourceNotFound",r);let n=l.parseXML(e.body);switch(n.code){case"AuthorizationHeaderMalformed":throw new S(n.message,n.code);default:throw new O(n.message,n.code||"unknown",r)}}},X=class{name;creationDate;constructor(e,r){this.name=e,this.creationDate=r}},$=class{key;lastModified;etag;size;storageClass;data;constructor(e,r,s,t,n,o){this.key=e,this.lastModified=r,this.etag=s,this.size=t,this.storageClass=n,this.data=o}},L=class i{key;etag;crc32;crc32c;crc64nvme;sha1;sha256;checksumType;size;constructor(e,r,s){this.key=e,this.etag=r,this.crc32=s?.crc32,this.crc32c=s?.crc32c,this.crc64nvme=s?.crc64nvme,this.sha1=s?.sha1,this.sha256=s?.sha256,this.checksumType=s?.checksumType||"FULL_OBJECT",this.size=s?.size}static fromResponse(e,r){let s={};e.headers["x-amz-checksum-crc32"]&&(s.crc32=e.headers["x-amz-checksum-crc32"]),e.headers["x-amz-checksum-crc32c"]&&(s.crc32c=e.headers["x-amz-checksum-crc32c"]),e.headers["x-amz-checksum-crc64nvme"]&&(s.crc64nvme=e.headers["x-amz-checksum-crc64nvme"]),e.headers["x-amz-checksum-sha1"]&&(s.sha1=e.headers["x-amz-checksum-sha1"]),e.headers["x-amz-checksum-sha256"]&&(s.sha256=e.headers["x-amz-checksum-sha256"]),e.headers["x-amz-checksum-algorithm"]&&(s.checksumType=e.headers["x-amz-checksum-algorithm"]==="COMPOSITE"?"COMPOSITE":"FULL_OBJECT"),e.headers["x-amz-object-size"]&&(s.size=parseInt(e.headers["x-amz-object-size"]));let t=e.headers.ETag||"";return new i(r,t,s)}},v=class{key;uploadId;constructor(e,r){this.key=e,this.uploadId=r}},G=class{partNumber;eTag;constructor(e,r){this.partNumber=e,this.eTag=r}},O=class extends l{operation;constructor(e,r,s){super(e,r),this.name="S3ServiceError",this.operation=s}};export{j as AWSConfig,l as AWSError,D as DNSError,_ as GeneralError,I as HTTP2Error,f as InvalidAWSConfigError,S as InvalidSignatureError,m as NetworkError,X as S3Bucket,F as S3Client,v as S3MultipartUpload,$ as S3Object,G as S3Part,O as S3ServiceError,L as S3UploadedObject,H as TCPError,C as TLSError};
//# sourceMappingURL=s3.js.map
